backlog:
  meta:
    titulo: "Kill-Switch Deep Research + Chat simple con modelos Saptiva"
    version: "2025-09-29"
    estados_validos: ["todo", "in_progress", "blocked", "done"]
    prioridades_validas: ["P0", "P1", "P2"]
    env_recomendado:
      - "DEEP_RESEARCH_KILL_SWITCH=true   # domina todo"
      - "DEEP_RESEARCH_ENABLED=false      # redundante, por claridad"
      - "DEEP_RESEARCH_AUTO=false         # sin heurísticas"
      - "CHAT_DEFAULT_MODEL=saptiva_turbo # o saptiva_base"
      - "CHAT_ALLOWED_MODELS=saptiva_turbo,saptiva_base"
      - "FEATURE_FLAGS_EXPOSE_ENDPOINT=true # para evidencias cURL"

  tasks:

    - id_task: "P0-DR-KILL-001"
      estado: "todo"
      prioridad: "P0"
      descripcion: >
        Implementar KILL SWITCH global para Deep Research en BE y FE.
        Con DEEP_RESEARCH_KILL_SWITCH=true todas las rutas/acciones de research
        devuelven 410 GONE (o 403) y en FE no se renderiza ni se puede invocar.
      criterio_de_aceptacion:
        - "Cualquier intento a /research/* responde 410 GONE {error_code: 'DEEP_RESEARCH_DISABLED'}."
        - "No existe código ejecutable que arranque research desde middleware, jobs o heurísticas."
        - "Build de FE no incluye módulos de research cuando el flag=true (tree-shaking o guardias)."
      stopper:
        - "Endoints legacy que re-encolen research sin pasar por el guard."
      componentes: ["backend/research/*", "frontend/tools/research", "middleware"]
      deps: []
      pruebas:
        unit:
          - "Middleware retorna 410 si flag=true"
        e2e:
          - "Navegar y usar chat no genera side-effects de research"
      verificacion_manual:
        - "Grep en repo de nombres startDeepResearch|autoResearch|researchCoordinator → 0 paths activos."
      evidencias:
        - "docs/evidencias/funcionamiento.md → cURL a /research/start sin 'explicit' ⇒ 410"
        - "docs/evidencias/funcionamiento.md → cURL a /research (list) ⇒ vacío para USER_ID"

    - id_task: "P0-DR-FE-002"
      estado: "todo"
      prioridad: "P0"
      descripcion: >
        Ocultar o deshabilitar completamente la UI de Deep Research.
        El toggle/botón permanece visible solo si se requiere, pero en estado disabled
        con tooltip 'Desactivado temporalmente' y sin listeners.
      criterio_de_aceptacion:
        - "No hay handlers que llamen research desde la UI."
        - "Con kill-switch ON no se bundlea código de research (import dinámico o guard)."
      stopper:
        - "Imports directos hard-coded en componentes compartidos."
      componentes: ["frontend/ui", "frontend/chat"]
      deps: ["P0-DR-KILL-001"]
      pruebas:
        unit:
          - "Componente renderiza disabled si flag=true"
        e2e:
          - "Click en toggle no dispara request"
      verificacion_manual:
        - "Inspección del bundle: no aparecen símbolos de research."
      evidencias:
        - "docs/evidencias/funcionamiento.md → dump de feature-flags vía cURL mostrando flags en false/kill=true"

    - id_task: "P0-DR-BE-003"
      estado: "todo"
      prioridad: "P0"
      descripcion: >
        Guardias en servidor: todos los controladores de research verifican
        DEEP_RESEARCH_KILL_SWITCH y abortan con 410, log estructurado y sin side-effects.
      criterio_de_aceptacion:
        - "Logs con event=research_blocked y user_id."
        - "No se crean jobs/threads al recibir la petición."
      stopper:
        - "Workers que ignoran la capa HTTP y leen colas antiguas."
      componentes: ["backend/research/controllers", "backend/logs"]
      deps: ["P0-DR-KILL-001"]
      pruebas:
        unit:
          - "Controlador retorna 410 con flag"
      verificacion_manual:
        - "Revisar cola de jobs: 0 encolados tras cURLs de prueba."
      evidencias:
        - "docs/evidencias/funcionamiento.md → cURL + snippet de log JSON"

    - id_task: "P0-CHAT-BASE-004"
      estado: "todo"
      prioridad: "P0"
      descripcion: >
        Forzar el flujo de chat a usar únicamente modelos Saptiva (simple inference).
        UI con selector limitado a CHAT_ALLOWED_MODELS. Quitar cualquier router hacia
        research coordinator. Modelo por defecto CHAT_DEFAULT_MODEL.
      criterio_de_aceptacion:
        - "Enviar mensaje → sólo golpea /llm/generate (o endpoint simple) con model permitido."
        - "Si el usuario intenta habilitar research no ocurre nada (UI disabled)."
      stopper:
        - "Dependencias que asumen siempre la presencia del coordinator."
      componentes: ["frontend/chat", "backend/llm"]
      deps: []
      pruebas:
        unit:
          - "Hook de envío no llama research"
        e2e:
          - "Chat responde con Saptiva Turbo y headers correctos"
      verificacion_manual:
        - "Observabilidad muestra únicamente llamadas a endpoint de modelos."
      evidencias:
        - "docs/evidencias/funcionamiento.md → cURL a /models/list y /chat/send (model=CHAT_DEFAULT_MODEL)"

    - id_task: "P0-DOCS-005"
      estado: "todo"
      prioridad: "P0"
      descripcion: >
        Crear docs/evidencias/funcionamiento.md con cURLs reproducibles usando usuario
        identificado, mostrando que research está bloqueado y que el chat funciona con
        modelo Saptiva. Sin videos.
      criterio_de_aceptacion:
        - "Archivo existe, cURLs devuelven 410 en research y 200 en chat."
        - "Incluye variables BASE_URL, TOKEN, USER_ID y rutas reales."
      stopper:
        - "Endpoint para exponer flags no disponible."
      componentes: ["docs"]
      deps: ["P0-DR-KILL-001", "P0-CHAT-BASE-004"]
      pruebas:
        unit: []
      verificacion_manual:
        - "Correr todos los cURLs y pegar respuestas sanitisadas."
      evidencias:
        - "El propio MD con salidas pegadas."

    - id_task: "P1-BUILD-006"
      estado: "todo"
      prioridad: "P1"
      descripcion: >
        Guardias de build: ESLint/TS rule que falla si se importa 'startDeepResearch'
        cuando DEEP_RESEARCH_KILL_SWITCH=true. Objetivo: impedir regresiones.
      criterio_de_aceptacion:
        - "CI falla si se re-importa el módulo bajo kill-switch."
      stopper:
        - "Monorepo sin soporte de rules condicionales."
      componentes: ["ci", "lint", "build"]
      deps: ["P0-DR-KILL-001"]
      pruebas:
        unit: []
      verificacion_manual:
        - "Forzar un import de prueba y ver CI fallar."
      evidencias:
        - "Registro del job de CI pegado en MD."

