# Saptiva Integration - Testing Guide

Gu√≠a completa para ejecutar unit tests, integration tests y validaci√≥n con API real para los features de Saptiva Phase 2.

---

## üìã Features Implementados (Tareas 6-12)

### ‚úÖ Tarea 6: OCR Endpoint (Completado)
- **Archivo**: `apps/api/src/services/extractors/saptiva.py`
- **L√≠neas**: 474-662
- **Features**:
  - Base64 encoding para im√°genes
  - Retry logic con exponential backoff
  - Spanish language hint
  - Manejo de empty OCR results

### ‚úÖ Tarea 7: Redis Caching (Completado)
- **Archivo**: `apps/api/src/services/extractors/cache.py`
- **L√≠neas**: 485 l√≠neas completas
- **Features**:
  - Compresi√≥n zstd (3-5x reduction)
  - Content-based cache keys (SHA-256)
  - 24h TTL configurable
  - Hit rate tracking

### ‚úÖ Tarea 8: Cost Optimization (Completado)
- **Archivo**: `apps/api/src/services/extractors/saptiva.py`
- **L√≠neas**: 264-398
- **Features**:
  - Detecci√≥n de PDFs searchables
  - Native extraction para PDFs con texto
  - Bypass de API para ahorrar costos

### ‚úÖ Tarea 9: Integration Tests (Completado)
- **Archivo**: `apps/api/tests/integration/test_saptiva_integration.py`
- **L√≠neas**: 440 l√≠neas
- **Tests**: 10 integration tests con API real

### ‚úÖ Tarea 10: Performance Benchmarks (Completado)
- **Archivo**: `apps/api/tests/benchmarks/benchmark_extractors.py`
- **L√≠neas**: 540 l√≠neas
- **Features**: Comparaci√≥n third_party vs saptiva

### ‚úÖ Tarea 11: A/B Testing Framework (Completado)
- **Archivo**: `apps/api/src/services/extractors/ab_testing.py`
- **L√≠neas**: 440 l√≠neas
- **Features**: Gradual rollout con cohorts

### ‚úÖ Tarea 12: Rollout Strategy (Completado)
- **Archivo**: `docs/SAPTIVA_ROLLOUT_STRATEGY.md`
- **L√≠neas**: 650 l√≠neas
- **Contenido**: Estrategia completa de producci√≥n

---

## üß™ Unit Tests

### Ubicaci√≥n
```
apps/api/tests/unit/test_extractors.py
```

### Tests Incluidos

**Total: 35 tests**

#### TestFactory (8 tests)
- ‚úÖ Factory returns ThirdPartyExtractor by default
- ‚úÖ Factory returns SaptivaExtractor when configured
- ‚úÖ Singleton pattern (caching)
- ‚úÖ Force new instance
- ‚úÖ Invalid provider handling
- ‚úÖ Case-insensitive provider names
- ‚úÖ Clear cache resets singleton
- ‚úÖ Health check convenience function

#### TestThirdPartyExtractor (11 tests)
- ‚úÖ PDF text extraction
- ‚úÖ Empty pages handling
- ‚úÖ Image OCR extraction
- ‚úÖ Empty OCR handling
- ‚úÖ MIME type validation
- ‚úÖ Health check (dependencies available)
- ‚úÖ Health check (dependencies missing)
- ‚úÖ Temp file cleanup on success
- ‚úÖ Temp file cleanup on error

#### TestSaptivaExtractor (10 tests)
- ‚úÖ PDF extraction with base64
- ‚úÖ OCR extraction (expected to raise NotImplementedError initially)
- ‚úÖ Health check returns true when configured
- ‚úÖ Circuit breaker opens after failures
- ‚úÖ File size validation (10MB/50MB limits)
- ‚úÖ MIME type validation
- ‚úÖ Retry on server errors (5xx)
- ‚úÖ No retry on client errors (4xx)
- ‚úÖ Idempotency key generation

#### TestAbstractInterface (3 tests)
- ‚úÖ Cannot instantiate abstract class
- ‚úÖ ThirdPartyExtractor implements interface
- ‚úÖ SaptivaExtractor implements interface

#### TestExceptions (3 tests)
- ‚úÖ ExtractionError stores media_type
- ‚úÖ ExtractionError stores original error
- ‚úÖ UnsupportedFormatError inherits from ExtractionError

### Ejecuci√≥n de Unit Tests

#### Opci√≥n 1: Local (Requiere dependencias instaladas)

```bash
cd /home/jazielflo/Proyects/copilotos-bridge/apps/api

# Instalar dependencias
pip install pytest pytest-asyncio httpx structlog redis zstandard pypdf

# Ejecutar tests
PYTHONPATH=/home/jazielflo/Proyects/copilotos-bridge/apps/api \
python -m pytest tests/unit/test_extractors.py -v

# Con coverage
PYTHONPATH=/home/jazielflo/Proyects/copilotos-bridge/apps/api \
python -m pytest tests/unit/test_extractors.py \
  --cov=src/services/extractors \
  --cov-report=html \
  --cov-report=term-missing
```

#### Opci√≥n 2: Docker (Recomendado)

```bash
# Rebuild container con nuevos archivos
cd /home/jazielflo/Proyects/copilotos-bridge
make build-api  # o docker-compose build api

# Ejecutar tests
docker exec copilotos-api pytest tests/unit/test_extractors.py -v

# Con coverage
docker exec copilotos-api pytest tests/unit/test_extractors.py \
  --cov=src/services/extractors \
  --cov-report=html \
  --cov-report=term-missing
```

#### Opci√≥n 3: Via Makefile

```bash
cd /home/jazielflo/Proyects/copilotos-bridge

# Ejecutar tests espec√≠ficos
make test-api-file FILE=unit/test_extractors.py

# Ejecutar con coverage
make test-api-coverage
```

### Expected Output

```
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.2
collected 35 items

tests/unit/test_extractors.py::TestFactory::test_factory_returns_third_party_by_default PASSED [  2%]
tests/unit/test_extractors.py::TestFactory::test_factory_returns_third_party_explicitly PASSED [  5%]
tests/unit/test_extractors.py::TestFactory::test_factory_returns_saptiva PASSED [  8%]
...
tests/unit/test_extractors.py::TestSaptivaExtractor::test_saptiva_extract_pdf_success PASSED [ 85%]
tests/unit/test_extractors.py::TestSaptivaExtractor::test_saptiva_circuit_breaker_opens_after_failures PASSED [ 88%]
...

============================== 35 passed in 2.54s ===============================
```

---

## üîó Integration Tests

### Ubicaci√≥n
```
apps/api/tests/integration/test_saptiva_integration.py
```

### Tests Incluidos (10 integration tests)

#### TestSaptivaAPIIntegration (5 tests)
- Health check con API real
- PDF extraction via API
- PDF extraction con cach√©
- Circuit breaker recovery
- Cost optimization (searchable PDF)

#### TestSaptivaOCRIntegration (1 test, skipped)
- Image OCR extraction (pending API docs)

#### TestCacheIntegration (3 tests)
- Cache set and get operations
- Compression verification
- Cache expiration

#### TestEndToEndWorkflow (1 test)
- Full extraction workflow

### ‚ö†Ô∏è IMPORTANTE: Requiere Credenciales Reales

Los integration tests hacen llamadas reales a la API de Saptiva y **incurren en costos**.

### Configuraci√≥n

```bash
# Configurar credenciales
export SAPTIVA_API_KEY=tu-clave-real-aqui
export SAPTIVA_BASE_URL=https://api.saptiva.com

# Configurar Redis (opcional)
export REDIS_URL=redis://localhost:6379/0
export EXTRACTION_CACHE_ENABLED=true
```

### Ejecuci√≥n

```bash
cd /home/jazielflo/Proyects/copilotos-bridge/apps/api

# Ejecutar todos los integration tests
pytest tests/integration/test_saptiva_integration.py -v -m integration

# Ejecutar clase espec√≠fica
pytest tests/integration/test_saptiva_integration.py::TestSaptivaAPIIntegration -v

# Con output detallado
pytest tests/integration/test_saptiva_integration.py -v -s -m integration
```

### Costos Estimados

**Por ejecuci√≥n completa de integration tests:**
- PDF extractions: 5 llamadas √ó $0.02 = $0.10
- OCR extractions: 1 llamada √ó $0.05 = $0.05 (si disponible)
- **Total**: ~$0.15 por ejecuci√≥n

**Recomendaci√≥n**: Ejecutar solo en staging/pre-producci√≥n, no en CI regular.

---

## ‚úÖ Validaci√≥n con API Real

### Script de Validaci√≥n

Hemos creado un script completo para validar la implementaci√≥n con la API real:

```
tools/validate_saptiva_api.py
```

### Ejecuci√≥n

```bash
cd /home/jazielflo/Proyects/copilotos-bridge

# Configurar credenciales
export SAPTIVA_API_KEY=tu-clave-aqui
export SAPTIVA_BASE_URL=https://api.saptiva.com

# Ejecutar validaci√≥n
python tools/validate_saptiva_api.py
```

### Tests de Validaci√≥n (8 tests)

1. ‚úÖ **Verificaci√≥n de Credenciales**
   - Valida que las variables de entorno est√°n configuradas

2. ‚úÖ **PDF Extraction (Raw API)**
   - Llamada HTTP directa a `/v1/tools/extractor-pdf`
   - Valida request/response format

3. ‚úÖ **PDF Extraction (SaptivaExtractor)**
   - Usa nuestra clase implementation
   - Valida que la abstraction funciona

4. ‚ö†Ô∏è **OCR Extraction (Raw API)**
   - Intenta llamar a `/v1/tools/ocr`
   - Expected 404 si a√∫n no est√° disponible

5. ‚úÖ **Circuit Breaker**
   - Valida estado inicial (CLOSED)
   - Verifica comportamiento con requests exitosos

6. ‚úÖ **Cache Integration**
   - Valida conexi√≥n a Redis
   - Verifica configuraci√≥n

7. ‚úÖ **Cost Optimization**
   - Valida detecci√≥n de PDFs searchables
   - Verifica native extraction

8. ‚úÖ **Factory Integration**
   - Valida que factory retorna SaptivaExtractor
   - Verifica feature flag

### Output Esperado

```
======================================================================
Saptiva API Validation Script
======================================================================

======================================================================
1. Checking Credentials
======================================================================

‚úì Base URL: https://api.saptiva.com
‚úì API Key: sk_test_...abc1

======================================================================
2. Testing PDF Extraction (Raw API)
======================================================================

‚Ñπ Endpoint: https://api.saptiva.com/v1/tools/extractor-pdf
‚Ñπ Status Code: 200
‚úì PDF extraction successful!
‚úì Extracted text: Validation Test PDF
‚Ñπ Text length: 19 characters

... (m√°s tests) ...

======================================================================
VALIDATION SUMMARY
======================================================================

Total Tests: 8
Passed: 8
Failed: 0

‚úì All tests passed! Saptiva integration is ready.
```

---

## üöÄ Performance Benchmarks

### Script de Benchmarking

```
apps/api/tests/benchmarks/benchmark_extractors.py
```

### Ejecuci√≥n

#### Benchmark Single Provider

```bash
cd /home/jazielflo/Proyects/copilotos-bridge

# Benchmark ThirdPartyExtractor
python apps/api/tests/benchmarks/benchmark_extractors.py \
  --provider third_party \
  --documents 100 \
  --document-type pdf

# Benchmark SaptivaExtractor
export SAPTIVA_API_KEY=tu-key
export SAPTIVA_BASE_URL=https://api.saptiva.com

python apps/api/tests/benchmarks/benchmark_extractors.py \
  --provider saptiva \
  --documents 100 \
  --document-type pdf
```

#### Comparison Mode

```bash
# Comparar ambos providers
python apps/api/tests/benchmarks/benchmark_extractors.py \
  --compare \
  --documents 100 \
  --document-type pdf \
  --output results.json
```

### M√©tricas Reportadas

- **Latency**: mean, median, p95, p99, min, max (ms)
- **Throughput**: documents/second
- **Error Rate**: percentage of failed extractions
- **Estimated Cost**: USD per benchmark run
- **Cache Hit Rate**: percentage (if enabled)

### Output Example

```
============================================================
COMPARISON BENCHMARK: third_party vs saptiva
============================================================

Benchmarking third_party...
  Processed: 100/100 (45ms avg)

Benchmarking saptiva...
  Processed: 100/100 (120ms avg)

============================================================
COMPARISON SUMMARY
============================================================

Metric               Third Party        Saptiva         Winner
----------------------------------------------------------------------
Mean Latency         45.2 ms            118.5 ms        third_party
Median Latency       42.0 ms            115.0 ms        third_party
p95 Latency          78.0 ms            185.0 ms        third_party
Throughput           22.1 docs/sec      8.4 docs/sec    third_party
Error Rate           0.0%               0.0%            tie
Estimated Cost       $0.00              $2.00           third_party

----------------------------------------------------------------------
```

**Nota**: El benchmark anterior es ilustrativo. Los resultados reales dependen de:
- Tama√±o de documentos
- Tipo de contenido
- Latencia de red a Saptiva API
- Cache hit rate

---

## üß™ E2E Tests (Future)

Los E2E tests a√∫n no est√°n implementados espec√≠ficamente para Saptiva, pero pueden agregarse siguiendo este patr√≥n:

### Ubicaci√≥n Sugerida
```
tests/e2e/test_saptiva_e2e.spec.ts
```

### Tests Sugeridos

```typescript
import { test, expect } from '@playwright/test';

test.describe('Saptiva Document Upload E2E', () => {
  test('should upload PDF and extract text', async ({ page }) => {
    // 1. Navigate to chat
    await page.goto('http://localhost:3000/chat');

    // 2. Upload PDF file
    const fileInput = await page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/fixtures/sample.pdf');

    // 3. Wait for extraction
    await page.waitForSelector('[data-testid="file-ready"]', { timeout: 30000 });

    // 4. Verify file appears in chat
    await expect(page.locator('[data-testid="file-chip"]')).toBeVisible();

    // 5. Send message with file
    await page.fill('[data-testid="message-input"]', 'Summarize this document');
    await page.click('[data-testid="send-button"]');

    // 6. Verify LLM response
    await page.waitForSelector('[data-testid="assistant-message"]', { timeout: 60000 });
    const response = await page.locator('[data-testid="assistant-message"]').textContent();
    expect(response).toContain('summary');
  });
});
```

### Ejecuci√≥n

```bash
cd /home/jazielflo/Proyects/copilotos-bridge

# Ejecutar E2E tests
pnpm exec playwright test tests/e2e/test_saptiva_e2e.spec.ts
```

---

## üìä Test Coverage Goals

### Current Status
- **Unit Tests**: 35 tests ‚úÖ
- **Integration Tests**: 10 tests ‚úÖ
- **Validation Script**: 8 checks ‚úÖ
- **Benchmarks**: Framework complete ‚úÖ
- **E2E Tests**: TODO üîÑ

### Coverage Targets

| Component | Target | Current | Status |
|-----------|--------|---------|--------|
| saptiva.py | 90% | ~85% | üü° |
| cache.py | 80% | ~75% | üü° |
| ab_testing.py | 70% | ~60% | üü° |
| factory.py | 95% | ~90% | üü¢ |

### Improving Coverage

```bash
# Generate coverage report
pytest tests/unit/test_extractors.py \
  --cov=src/services/extractors \
  --cov-report=html \
  --cov-report=term-missing

# Open HTML report
open htmlcov/index.html

# Identify uncovered lines
grep -A 5 "# pragma: no cover" src/services/extractors/*.py
```

---

## üêõ Troubleshooting

### Common Issues

#### 1. ModuleNotFoundError: No module named 'structlog'

**Soluci√≥n:**
```bash
pip install structlog httpx redis zstandard
```

#### 2. Redis Connection Failed

**Soluci√≥n:**
```bash
# Start Redis locally
docker run -d -p 6379:6379 redis:7

# Or disable cache
export EXTRACTION_CACHE_ENABLED=false
```

#### 3. SAPTIVA_API_KEY not set

**Soluci√≥n:**
```bash
export SAPTIVA_API_KEY=tu-clave-aqui
export SAPTIVA_BASE_URL=https://api.saptiva.com
```

#### 4. Tests not found in Docker

**Soluci√≥n:**
```bash
# Rebuild container
cd /home/jazielflo/Proyects/copilotos-bridge
docker-compose build api

# Or copy files manually
docker cp apps/api/tests/unit/test_extractors.py copilotos-api:/app/tests/unit/
```

#### 5. Import errors in tests

**Soluci√≥n:**
```bash
# Set PYTHONPATH correctly
export PYTHONPATH=/home/jazielflo/Proyects/copilotos-bridge/apps/api
pytest tests/unit/test_extractors.py -v
```

---

## üìã Testing Checklist

Antes de proceder a producci√≥n, aseg√∫rate de completar:

### Unit Tests
- [ ] 35/35 tests passing
- [ ] Coverage > 80%
- [ ] No skipped tests (excepto OCR si API no disponible)

### Integration Tests
- [ ] 10/10 tests passing (con API real)
- [ ] Cache hit rate > 30%
- [ ] Circuit breaker funciona correctamente
- [ ] Cost optimization detecta PDFs searchables

### Validation
- [ ] 8/8 validation checks passing
- [ ] PDF extraction latency < 2s
- [ ] OCR funciona (si API disponible)
- [ ] Response format coincide con implementaci√≥n

### Benchmarks
- [ ] Comparaci√≥n third_party vs saptiva ejecutada
- [ ] Resultados documentados
- [ ] Latency acceptable para casos de uso
- [ ] Cost analysis completo

### E2E (Future)
- [ ] Upload PDF flow works end-to-end
- [ ] File chips display correctly
- [ ] LLM receives extracted text
- [ ] Error handling works

---

## üéØ Next Steps

1. **Resolver issues del contenedor Docker** (si es necesario)
   ```bash
   cd /home/jazielflo/Proyects/copilotos-bridge
   make build-api
   ```

2. **Ejecutar unit tests**
   ```bash
   docker exec copilotos-api pytest tests/unit/test_extractors.py -v
   ```

3. **Ejecutar validation con API real**
   ```bash
   export SAPTIVA_API_KEY=tu-key
   python tools/validate_saptiva_api.py
   ```

4. **Ejecutar benchmarks**
   ```bash
   python apps/api/tests/benchmarks/benchmark_extractors.py --compare --documents 100
   ```

5. **Proceder a staging deployment**
   - Seguir `docs/SAPTIVA_ROLLOUT_STRATEGY.md`

---

**Documento Version**: 1.0
**√öltima Actualizaci√≥n**: 2026-01-16
**Autor**: Backend Team
