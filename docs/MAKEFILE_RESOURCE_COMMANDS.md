# Makefile - Comandos de Optimizaci√≥n de Recursos

## üìä Comandos Disponibles

### 1. `make resources`

**Descripci√≥n:** Muestra un resumen completo del uso de recursos de Docker y del sistema.

**Output:**
```
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîµ  üìä Docker Resources Summary
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üü° Docker Disk Usage:
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          4         4         2.924GB   18.86MB (0%)
Containers      4         4         18.76MB   0B (0%)
Local Volumes   24        4         1.532GB   1.164GB (75%)
Build Cache     0         0         0B        0B

üü° Container Resources:
CONTAINER      CPU %     MEM USAGE / LIMIT     MEM %
copilotos-web  0.02%     378MiB / 7.465GiB     4.95%
copilotos-api  0.23%     75.79MiB / 7.465GiB   0.99%
...

üü° System Memory:
              total        used        free      available
Mem:          7.5Gi       1.8Gi       4.8Gi     5.5Gi
Swap:         2.0Gi          0B       2.0Gi
```

**Cu√°ndo usar:**
- Verificar cu√°nto espacio est√°n usando tus contenedores
- Identificar si hay espacio reclaimable
- Monitorear uso de RAM y CPU de contenedores

---

### 2. `make resources-monitor`

**Descripci√≥n:** Monitoreo en tiempo real de recursos de Docker (actualiza cada 2 segundos).

**Output:**
```
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîµ  üìä Real-time Resource Monitor (Ctrl+C to stop)
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

CONTAINER      CPU %     MEM USAGE / LIMIT     MEM %     NET I/O
copilotos-web  0.15%     380MiB / 7.465GiB     4.98%     1.2kB / 0B
copilotos-api  0.30%     76MiB / 7.465GiB      1.00%     0B / 0B
...
```

**Cu√°ndo usar:**
- Debugging de problemas de performance
- Identificar contenedores que consumen muchos recursos
- Verificar que los l√≠mites de recursos est√°n funcionando

**Tip:** Presiona `Ctrl+C` para salir del monitor

---

### 3. `make docker-cleanup`

**Descripci√≥n:** Limpieza segura de Docker (build cache, im√°genes dangling, contenedores detenidos).

**Caracter√≠sticas:**
- ‚úÖ Elimina build cache antiguo (>7 d√≠as)
- ‚úÖ Elimina im√°genes sin tag (dangling)
- ‚úÖ Elimina contenedores detenidos
- ‚ö†Ô∏è Pregunta confirmaci√≥n para vol√∫menes hu√©rfanos
- ‚úÖ NO afecta contenedores activos
- ‚úÖ NO afecta im√°genes en uso

**Output:**
```
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîµ  üßπ Docker Safe Cleanup
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Uso actual de Docker:
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          34        4         46.83GB   44.3GB (94%)
...

1. Eliminando im√°genes sin tag (dangling)...
‚úì Eliminadas 7 im√°genes dangling

2. Eliminando contenedores detenidos...
‚úì Eliminados 8 contenedores detenidos

3. Limpiando build cache antiguo (>7 d√≠as)...
‚úì Build cache antiguo eliminado

4. Vol√∫menes hu√©rfanos detectados:
   Encontrados 45 vol√∫menes hu√©rfanos
   ¬øEliminar vol√∫menes hu√©rfanos? (y/N):
```

**Cu√°ndo usar:**
- Mantenimiento semanal regular
- Antes de deployments importantes
- Cuando el disco se est√° llenando
- Despu√©s de m√∫ltiples rebuilds

**Espacio t√≠pico liberado:** 5-30 GB

---

### 4. `make docker-cleanup-aggressive`

**Descripci√≥n:** Limpieza agresiva que elimina TODO lo que no est√© en uso actualmente.

**‚ö†Ô∏è ADVERTENCIA:** Este comando elimina:
- ‚ùå TODAS las im√°genes no usadas por contenedores activos
- ‚ùå TODOS los vol√∫menes hu√©rfanos
- ‚ùå TODO el build cache
- ‚úÖ NO afecta contenedores activos ni sus im√°genes

**Confirmaci√≥n requerida:**
```
‚ö†Ô∏è  WARNING: This will remove ALL unused Docker images and volumes!
Active containers will NOT be affected.

Are you sure? (yes/NO):
```

**Output:**
```
Removing all unused images...
Deleted Images:
untagged: old-image:latest
...
Total reclaimed space: 44.3GB

Removing all unused volumes...
Total reclaimed space: 2.3GB

Removing all build cache...
Total reclaimed space: 25.5GB

‚úì Aggressive cleanup completed!

TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          4         4         2.9GB     0B (0%)
Containers      4         4         18.7MB    0B (0%)
Local Volumes   4         4         370MB     0B (0%)
Build Cache     0         0         0B        0B
```

**Cu√°ndo usar:**
- Cuando necesitas liberar MUCHO espacio r√°pido
- Antes de re-clonar el proyecto
- Limpieza profunda mensual
- Preparaci√≥n para deployment mayor

**Espacio t√≠pico liberado:** 50-70 GB

**‚ö†Ô∏è Consecuencias:**
- Next.js necesitar√° rebuildearse desde cero
- Primeros builds ser√°n m√°s lentos (sin cache)
- Im√°genes de test/desarrollo ser√°n eliminadas

---

### 5. `make build-optimized`

**Descripci√≥n:** Build de im√°genes con optimizaciones activadas.

**Optimizaciones incluidas:**
- ‚úÖ Multi-stage builds (separaci√≥n build/runtime)
- ‚úÖ Build cache inline (reutilizaci√≥n entre builds)
- ‚úÖ Layer caching optimizado
- ‚úÖ Eliminaci√≥n de dependencias de desarrollo en producci√≥n

**Output:**
```
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîµ  üèóÔ∏è  Building Optimized Docker Images
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Optimizations enabled:
  ‚Ä¢ Multi-stage builds
  ‚Ä¢ Alpine base images where possible
  ‚Ä¢ Build cache utilization
  ‚Ä¢ Layer optimization

Building API (FastAPI)...
[+] Building 45.2s (18/18) FINISHED
...

Building Web (Next.js)...
[+] Building 120.5s (25/25) FINISHED
...

‚úì Optimized images built successfully!

Image sizes:
copilotos-api    latest    290MB
copilotos-web    latest    1.06GB
```

**Cu√°ndo usar:**
- Builds para producci√≥n
- Cuando quieres im√°genes m√°s peque√±as
- Antes de push a registry
- Deployment optimizado

**Beneficios:**
- Im√°genes 30-50% m√°s peque√±as
- Builds subsecuentes m√°s r√°pidos (cache)
- Menos transferencia de red en deploys
- Menor uso de disco en producci√≥n

---

### 6. `make deploy-optimized`

**Descripci√≥n:** Workflow completo de deployment optimizado.

**Pasos autom√°ticos:**
1. **Cleanup** ‚Üí Elimina build cache antiguo (>7 d√≠as)
2. **Build** ‚Üí Construye im√°genes optimizadas con cache
3. **Deploy** ‚Üí Ejecuta `make deploy-clean`
4. **Post-cleanup** ‚Üí Elimina dangling images generadas
5. **Report** ‚Üí Muestra uso de recursos final

**Output:**
```
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîµ  üöÄ Optimized Deployment Workflow
üîµ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Step 1: Cleanup old artifacts...
Deleted build cache 154MB

Step 2: Building optimized images...
[Runs make build-optimized]

Step 3: Deploying with resource limits...
[Runs make deploy-clean]

‚úì Optimized deployment completed!

Post-deployment cleanup...
Deleted dangling images: 3.4GB

[Shows final resource usage]
```

**Cu√°ndo usar:**
- Deployment a producci√≥n
- Deployment cr√≠tico que debe ser confiable
- Cuando quieres asegurar im√°genes limpias
- Releases importantes

**Tiempo estimado:** 15-20 minutos (build completo)

**Ventajas vs `make deploy-clean`:**
- Limpieza autom√°tica pre/post deployment
- Optimizaciones de build activadas
- Reporte de recursos incluido
- Menos intervenci√≥n manual

---

## üîÑ Workflows Recomendados

### Desarrollo Diario
```bash
# Ver recursos
make resources

# Si hay >10 GB reclaimable
make docker-cleanup
```

### Mantenimiento Semanal
```bash
# Limpieza segura
make docker-cleanup

# Verificar resultado
make resources
```

### Limpieza Profunda Mensual
```bash
# Backup importante primero (opcional)
make db-backup

# Limpieza agresiva
make docker-cleanup-aggressive

# Rebuild si es necesario
make dev-build
```

### Deployment a Producci√≥n
```bash
# Opci√≥n 1: R√°pido (si builds recientes son buenos)
make deploy-quick

# Opci√≥n 2: Optimizado (recomendado)
make deploy-optimized

# Opci√≥n 3: Clean build (garantizado fresco)
make deploy-clean
```

---

## üì¶ Usar L√≠mites de Recursos

### Activar L√≠mites de Recursos

```bash
# Development con l√≠mites
docker compose -f infra/docker-compose.yml \
               -f infra/docker-compose.dev.yml \
               -f infra/docker-compose.resources.yml \
               up

# Production con l√≠mites (recomendado)
docker compose -f infra/docker-compose.yml \
               -f infra/docker-compose.resources.yml \
               up
```

### L√≠mites Configurados

| Servicio | CPU Max | RAM Max | RAM Min |
|----------|---------|---------|---------|
| API      | 1 core  | 512 MB  | 128 MB  |
| Web      | 1 core  | 1 GB    | 256 MB  |
| MongoDB  | 1 core  | 512 MB  | 256 MB  |
| Redis    | 0.5 core| 128 MB  | 32 MB   |

### Beneficios de L√≠mites

- ‚úÖ Previene memory leaks que consuman toda la RAM
- ‚úÖ Distribuci√≥n justa de recursos
- ‚úÖ Facilita debugging (l√≠mites claros)
- ‚úÖ Permite correr m√°s servicios en mismo hardware
- ‚úÖ Evita OOM kills del sistema operativo

---

## üéì Tips y Mejores Pr√°cticas

### 1. Monitoreo Regular
```bash
# Ver uso actual
make resources

# Monitoreo continuo durante desarrollo
make resources-monitor
```

### 2. Limpieza Preventiva
```bash
# Cada semana
make docker-cleanup

# Antes de deployment importante
make docker-cleanup
```

### 3. Identificar Problemas

**Si un contenedor usa mucha RAM:**
```bash
# Ver logs para memory errors
make logs-api | grep -i "memory\|oom"

# Ver stats en tiempo real
make resources-monitor
```

**Si build cache crece mucho:**
```bash
# Ver tama√±o
docker system df

# Si >20 GB, limpiar
docker builder prune -af
```

### 4. Automatizaci√≥n

**Cron job para limpieza semanal:**
```bash
# Editar crontab
crontab -e

# Agregar (domingos 3 AM)
0 3 * * 0 cd /path/to/copilotos-bridge && make docker-cleanup >> /tmp/cleanup.log 2>&1
```

---

## ‚ö†Ô∏è Advertencias Importantes

### ‚ùå NO hacer en Producci√≥n Activa
```bash
# NUNCA en prod activo
make docker-cleanup-aggressive  # Puede eliminar im√°genes en uso
make clean-volumes              # P√âRDIDA DE DATOS
```

### ‚úÖ HACER Regularmente
```bash
# Seguro en cualquier momento
make resources                  # Solo lectura
make docker-cleanup             # Limpieza segura
make resources-monitor          # Solo observaci√≥n
```

### üîí Antes de Limpieza Agresiva
```bash
# 1. Backup de datos importantes
make db-backup

# 2. Verificar qu√© se eliminar√°
docker images --filter "dangling=false"

# 3. Confirmar que no hay deployments en curso
make status
```

---

## üìä M√©tricas de √âxito

### Uso √ìptimo de Recursos

| M√©trica | √ìptimo | Aceptable | Acci√≥n Requerida |
|---------|--------|-----------|------------------|
| Docker Images | <5 GB | 5-10 GB | >10 GB ‚Üí Cleanup |
| Build Cache | <5 GB | 5-15 GB | >15 GB ‚Üí Prune |
| Vol√∫menes | <2 GB | 2-5 GB | >5 GB ‚Üí Review |
| RAM Contenedores | <1 GB | 1-2 GB | >2 GB ‚Üí Investigate |

### Despu√©s de Limpieza Exitosa

```
‚úÖ Antes:  75 GB Docker total
‚úÖ Despu√©s: 4.5 GB Docker total
‚úÖ Liberado: 70.5 GB (94% reducci√≥n)
```

---

## üÜò Troubleshooting

### Problema: "No se liber√≥ espacio despu√©s de cleanup"

**Causa:** Im√°genes a√∫n en uso por contenedores detenidos.

**Soluci√≥n:**
```bash
# Ver contenedores detenidos
docker ps -a

# Eliminar contenedores detenidos
docker container prune -f

# Retry cleanup
make docker-cleanup
```

### Problema: "Build fall√≥ despu√©s de cleanup agresivo"

**Causa:** Build cache eliminado, build desde cero.

**Soluci√≥n:** Es esperado, solo toma m√°s tiempo.
```bash
# Primera vez ser√° lenta
make dev-build  # ~5-10 minutos

# Subsecuentes builds r√°pidas (cache rebuildeado)
make dev-build  # ~1-2 minutos
```

### Problema: "Container killed (OOMKilled)"

**Causa:** Contenedor excedi√≥ l√≠mite de memoria.

**Soluci√≥n:**
```bash
# Ver logs
docker logs <container_id>

# Opci√≥n 1: Aumentar l√≠mite en docker-compose.resources.yml
# memory: 512M ‚Üí memory: 1G

# Opci√≥n 2: Deshabilitar l√≠mites temporalmente
# No usar docker-compose.resources.yml
```

---

## üìö Referencias

- [Docker System Prune](https://docs.docker.com/engine/reference/commandline/system_prune/)
- [Docker Resource Constraints](https://docs.docker.com/config/containers/resource_constraints/)
- [RESOURCE_OPTIMIZATION.md](./RESOURCE_OPTIMIZATION.md) - Gu√≠a completa
- [Makefile](../Makefile) - C√≥digo fuente de comandos
