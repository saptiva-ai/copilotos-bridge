# CopilotOS Bridge ‚Äî Chat UI + Aletheia Deep Research

> UI estilo ChatGPT para interactuar con modelos de **Saptiva** y ejecutar **Deep Research** v√≠a el orquestador **Aletheia**.  
> Filosof√≠a operativa: *veracidad + trazabilidad + control de lo controlable* (estoicismo aplicado al stack).

---

## Objetivo

Unificar una **UI conversacional** (chat) con:
- **LLM directo** (mensajes r√°pidos) y
- **Deep Research** (pipeline iterativo con evidencia, citaciones y telemetr√≠a).

La UI debe permitir:
- Elegir modelo de Saptiva
- Lanzar **websearch** o **deep-research**
- Ver **streaming** de respuestas en tiempo real
- Mantener **hist√≥rico** de conversaciones y resultados (por `chat_id` / `task_id`)
- Descargar reporte final (MD/HTML/PDF) con metadatos
- Control granular de par√°metros de investigaci√≥n (budget, iteraciones, scope)

## Requisitos del Sistema

- **Node.js** >= 18.0.0
- **Python** >= 3.10
- **MongoDB** >= 6.0 (or MongoDB Atlas)
- **Redis** >= 6.2
- **Docker** y Docker Compose (para desarrollo local)
- **pnpm** >= 8.0 (recomendado) o npm/yarn

---

## Arquitectura (alto nivel)

```mermaid
flowchart LR
  %% --- STYLE FIRST (para motores viejos) ---
  classDef ui fill:#f6f5ff,stroke:#6e56cf,stroke-width:1px,color:#1b1a1f;

  %% --- SUBGRAPHS SIMPLIFICADOS ---
  subgraph UI ["CopilotOS UI"]
    C[Chat UI]:::ui
    M[Model Picker]:::ui
    T[Tools]
  end

  subgraph API ["Gateway Proxy FastAPI"]
    S[Session and History Service]
    E[SSE and WebSocket Streamer]
    A[Auth JWT]
    DB[MongoDB ODM Beanie]
  end

  subgraph ORCH ["DeepResearch API (Aletheia)"]
    R1[POST research]
    R2[POST deep research]
    TR[(OTel Spans and NDJSON Events)]
  end

  subgraph SVCS ["Servicios"]
    SA[Saptiva Models]
    TA[Tavily]
    WV[Weaviate Vector DB]
    MI[MinIO or S3 Artifacts]
    JG[Jaeger Tracing]
    GD[Guard Policies]
  end

  subgraph DATA ["Datos"]
    MG[(MongoDB)]
    RD[(Redis)]
  end

  %% --- FLUJOS SIN LABELS ---
  C --> S
  S --> ORCH

  DB --> MG
  S  --> RD

  ORCH --> SA
  ORCH --> TA
  ORCH --> WV
  ORCH --> MI
  ORCH --> JG
  ORCH --> GD

  E --> C
  E --> TR
```

---

## Contratos y Mapping

### Endpoints (este repo)
- `POST /api/chat` ‚Üí Mensaje directo al LLM (usa Saptiva).  
- `POST /api/deep-research` ‚Üí Inicia investigaci√≥n; devuelve `task_id`.  
- `GET  /api/stream/{task_id}` ‚Üí **SSE**: puentea eventos parciales desde Aletheia.  
- `GET  /api/report/{task_id}` ‚Üí Descarga el reporte final/artefactos.  
- `GET  /api/history/{chat_id}` ‚Üí Hist√≥rico de la conversaci√≥n y sus `task_id`.

### Handoff a Aletheia
- Proxy a `POST /research` y `POST /deep-research` con los par√°metros del UI.  
- Lectura de `runs/<task_id>/events.ndjson` para emitir *stream* SSE.  
- Descarga de `report.md`, `sources.bib` y m√©tricas para el usuario.

---

## Datos y Persistencia

- **MongoDB**: `users`, `chat_sessions`, `messages`, `tasks` (mapea `chat_id` ‚Üî `task_id`), `research_sources`, `evidence`.  
- **Redis**: sesiones y cach√© de respuestas parciales.  
- **MinIO/S3** (Aletheia): almacenamiento de artefactos (reportes/evidencia).

---

## Configuraci√≥n

### Variables de entorno requeridas (`.env`)

```bash
# ========================================
# AUTENTICACI√ìN
# ========================================
AUTH_JWT_SECRET=change-me-to-secure-random-string
AUTH_JWT_EXPIRY_HOURS=24

# ========================================
# ALETHEIA ORCHESTRATOR
# ========================================
ALETHEIA_BASE_URL=http://localhost:8000
ALETHEIA_API_KEY=optional-if-required
ALETHEIA_TIMEOUT_SECONDS=120
ALETHEIA_MAX_RETRIES=3

# ========================================
# STREAMING Y PERFORMANCE
# ========================================
STREAM_BACKPRESSURE_MAX=1000
STREAM_HEARTBEAT_INTERVAL_MS=5000
SSE_KEEP_ALIVE_TIMEOUT_MS=30000

# ========================================
# BASE DE DATOS
# ========================================
POSTGRES_URL=postgresql://user:pass@localhost:5432/copilotos
REDIS_URL=redis://localhost:6379/0
DB_POOL_SIZE=10
DB_CONNECTION_TIMEOUT_MS=5000

# ========================================
# L√çMITES Y SEGURIDAD
# ========================================
RATE_LIMIT_REQUESTS_PER_MINUTE=100
MAX_PROMPT_LENGTH=10000
MAX_UPLOAD_SIZE_MB=10
CORS_ORIGINS=http://localhost:3000,https://app.domain.com

# ========================================
# OBSERVABILIDAD
# ========================================
LOG_LEVEL=info
OTEL_SERVICE_NAME=copilotos-bridge
JAEGER_ENDPOINT=http://localhost:14268/api/traces
```

Variables de Aletheia (col√≥calas en su propio .env):

```bash
SAPTIVA_API_KEY=...
SAPTIVA_MODEL_PLANNER=SAPTIVA_OPS
SAPTIVA_MODEL_WRITER=SAPTIVA_CORTEX
TAVILY_API_KEY=...
VECTOR_BACKEND=weaviate
WEAVIATE_HOST=http://localhost:8080
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
ARTIFACTS_DIR=./runs
```

---

## Quickstart (local)

### Pre-requisitos
1) **Levantar Aletheia** (API + Weaviate + MinIO + Jaeger) siguiendo su repo
2) **Configurar bases de datos con Docker Compose** (recomendado):
```bash
# Iniciar MongoDB + Redis con configuraci√≥n predefinida
docker compose -f infra/docker/docker-compose.yml up -d

# Verificar que los servicios est√°n corriendo
docker compose -f infra/docker/docker-compose.yml ps

# Ver logs si hay problemas
docker compose -f infra/docker/docker-compose.yml logs mongodb redis
```

**Alternativa manual:**
```bash
# MongoDB standalone
docker run -d --name mongodb -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=copilotos_user \
  -e MONGO_INITDB_ROOT_PASSWORD=secure_password_change_me \
  mongo:6.0

# Redis standalone  
docker run -d --name redis -p 6379:6379 redis:7-alpine
```

### Instalaci√≥n y Configuraci√≥n
```bash
# 1) Clonar e instalar dependencias
git clone <repo-url>
cd copilotos-bridge
pnpm install  # o npm install / yarn install

# 2) Configurar variables de entorno
cp .env.example .env
cp apps/web/.env.local.example apps/web/.env.local
cp apps/api/.env.example apps/api/.env
# Editar archivos .env con tus credenciales

# 3) Construir shared package
pnpm --filter shared build

# 4) Verificar conexi√≥n a MongoDB (opcional)
python scripts/test-mongodb.py

# 5) Arrancar servicios en desarrollo
pnpm dev  # Next.js en http://localhost:3000 + API en http://localhost:8000
```

### Verificaci√≥n del Setup
- ‚úÖ UI accesible en `http://localhost:3000`
- ‚úÖ API respondiendo en `/api/health` (cuando se implemente)
- ‚úÖ MongoDB conectada y collections creadas
- ‚úÖ Redis funcionando para cache/sesiones
- ‚úÖ Conexi√≥n a Aletheia OK (cuando se configure)

### Uso B√°sico
1. **Chat directo**: Env√≠a mensaje y selecciona modelo
2. **Deep Research**: Activa "Investigar a fondo" y observa el streaming
3. **Historial**: Navega conversaciones anteriores
4. **Reportes**: Descarga resultados en formato deseado

---

## Tests & Quality

- **E2E** con Playwright (flujo chat + deep research).  
- **Contract tests** del proxy contra Aletheia.  
- **Tracing Assertions**: verifica presencia de spans clave.  
- **Feature flags**: activar/desactivar herramientas por entorno.

---

##  Roadmap corto (v1 ‚Üí v1.1)

- v1: Chat + Deep Research (SSE), hist√≥rico b√°sico, descarga de reporte.  
- v1.1: edici√≥n de prompts, renombrar/congelar conversaciones, compartir enlace de reporte, *retry* inteligente de pasos fallidos.

---

##  Estado Actual del Proyecto

### ‚úÖ **Completado (25%)**
- **üìÅ Estructura del monorepo**: Apps (web/api), packages (shared), infra, docs, tests
- **‚öôÔ∏è Configuraci√≥n base**: Variables de entorno, TypeScript, Tailwind, FastAPI
- **üóÑÔ∏è Base de datos**: Modelos MongoDB con Beanie ODM, √≠ndices optimizados
- **üìù Tipos compartidos**: Interfaces TypeScript + esquemas Zod + Pydantic
- **üê≥ Docker Compose**: MongoDB + Redis con healthchecks

### üöß **En Progreso**
- **Docker stack completo**: Faltan Dockerfiles para apps web/api

### **Pr√≥ximamente (prioridad cr√≠tica)**
1. **Endpoints FastAPI**: `/api/chat`, `/api/deep-research`, `/api/health`
2. **Componentes UI base**: Sistema de dise√±o, chat interface
3. **Autenticaci√≥n JWT**: Login, middleware, sesiones
4. **Seguridad**: Rate limiting, validaci√≥n, CORS

### **Stack Tecnol√≥gico Final**
```
Frontend:  Next.js 14 + TypeScript + Tailwind CSS + Zustand
Backend:   FastAPI + Pydantic 2.0 + Beanie ODM
Database:  MongoDB 6.0 + Redis 7
Deploy:    Docker Compose + (futuro: Kubernetes)
Monitoring: OpenTelemetry + Jaeger + Prometheus
```

---

##  Principios de dise√±o

- **Veracidad y trazabilidad primero**: toda afirmaci√≥n importante debe poder vincularse a evidencia.  
- **Separaci√≥n de preocupaciones**: UI ‚Üî Proxy ‚Üî Orquestador; puertos/adapters intercambiables.  
- **Observabilidad obligatoria**: spans + eventos estructurados; fallas visibles y depurables.  
- **Estoicismo aplicado**: centrarse en lo controlable (inputs, l√≠mites, telemetr√≠a) y no en el azar externo (latencia/red).

---

## Estructura del Proyecto

```
copilotos-bridge/
‚îú‚îÄ apps/
‚îÇ  ‚îú‚îÄ web/                   # Next.js 14+ (UI React/TypeScript)
‚îÇ  ‚îÇ  ‚îú‚îÄ src/
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ components/      # Componentes UI reutilizables
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ pages/api/       # API Routes de Next.js (proxy)
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ hooks/           # Custom React hooks
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ stores/          # Estado global (Zustand/Redux)
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ types/           # Tipos TypeScript espec√≠ficos del UI
‚îÇ  ‚îÇ  ‚îú‚îÄ public/
‚îÇ  ‚îÇ  ‚îî‚îÄ package.json
‚îÇ  ‚îî‚îÄ api/                   # FastAPI (alternativa al proxy de Next.js)
‚îÇ     ‚îú‚îÄ src/
‚îÇ     ‚îÇ  ‚îú‚îÄ routers/         # Endpoints organizados por dominio
‚îÇ     ‚îÇ  ‚îú‚îÄ services/        # L√≥gica de negocio
‚îÇ     ‚îÇ  ‚îú‚îÄ models/          # Modelos SQLAlchemy
‚îÇ     ‚îÇ  ‚îî‚îÄ middleware/      # Auth, CORS, rate limiting
‚îÇ     ‚îî‚îÄ requirements.txt
‚îú‚îÄ packages/
‚îÇ  ‚îî‚îÄ shared/                # Contratos y tipos compartidos
‚îÇ     ‚îú‚îÄ src/
‚îÇ     ‚îÇ  ‚îú‚îÄ types/           # Interfaces TypeScript
‚îÇ     ‚îÇ  ‚îú‚îÄ schemas/         # Esquemas de validaci√≥n (Zod/Pydantic)
‚îÇ     ‚îÇ  ‚îî‚îÄ constants/       # Constantes compartidas
‚îÇ     ‚îî‚îÄ package.json
‚îú‚îÄ infra/
‚îÇ  ‚îú‚îÄ docker/                # Configuraci√≥n Docker
‚îÇ  ‚îÇ  ‚îú‚îÄ docker-compose.yml
‚îÇ  ‚îÇ  ‚îú‚îÄ docker-compose.dev.yml
‚îÇ  ‚îÇ  ‚îî‚îÄ Dockerfiles/
‚îÇ  ‚îî‚îÄ k8s/                   # Manifiestos Kubernetes (opcional)
‚îú‚îÄ docs/
‚îÇ  ‚îú‚îÄ architecture/          # ADRs y diagramas de arquitectura
‚îÇ  ‚îú‚îÄ api/                   # Documentaci√≥n de endpoints
‚îÇ  ‚îî‚îÄ deployment/            # Gu√≠as de despliegue
‚îú‚îÄ tests/
‚îÇ  ‚îú‚îÄ e2e/                   # Tests end-to-end (Playwright)
‚îÇ  ‚îú‚îÄ integration/           # Tests de integraci√≥n
‚îÇ  ‚îî‚îÄ contract/              # Contract tests con Aletheia
‚îú‚îÄ scripts/                  # Scripts de automatizaci√≥n
‚îú‚îÄ .env.example
‚îú‚îÄ .env.local.example
‚îú‚îÄ pnpm-workspace.yaml
‚îî‚îÄ package.json
```

---

## Seguridad

- Sanitizar entradas y limitar tama√±o de prompts/archivos.  
- **Guard** en entrada/salida a trav√©s de Aletheia.  
- Rate limiting por IP/usuario y *circuit breakers* en el proxy.

---

## Troubleshooting

### Problemas Comunes

#### Error de conexi√≥n a MongoDB
```bash
# Verificar que MongoDB est√© corriendo
docker ps | grep mongodb
docker logs copilotos-mongodb

# Probar conexi√≥n manualmente
python scripts/test-mongodb.py

# Conectar con MongoDB shell
docker exec -it copilotos-mongodb mongosh -u copilotos_user -p secure_password_change_me

# Ver base de datos web UI (opcional)
docker compose -f infra/docker/docker-compose.yml --profile tools up -d mongo-express
# http://localhost:8081 (admin/admin123)
```

#### Error de conexi√≥n a Aletheia
```bash
# Verificar que Aletheia est√© corriendo
curl -f http://localhost:8000/health

# Revisar logs
docker logs aletheia-api
```

#### Streaming interrumpido
- Verificar `STREAM_BACKPRESSURE_MAX` y ajustar seg√∫n carga
- Revisar conexi√≥n de red y timeouts
- Comprobar logs del navegador para errores de EventSource

#### Redis no conecta
```bash
# Verificar Redis
redis-cli ping
# o con Docker:
docker exec copilotos-redis redis-cli ping

# Ver configuraci√≥n Redis
docker exec copilotos-redis redis-cli CONFIG GET "*"
```

#### Performance lenta
- Revisar `DB_POOL_SIZE` y ajustar para tu carga
- Monitorear m√©tricas en Jaeger
- Verificar √≠ndices de base de datos

### Logs y Debugging
```bash
# Logs detallados
export LOG_LEVEL=debug
pnpm dev

# Trazas distribuidas
# Abrir Jaeger UI en http://localhost:16686
```

## üìù Licencia

MIT (propuesta).
