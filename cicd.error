🚀 Deploy to Staging
failed now in 17s
Search logs
1s
Current runner version: '2.328.0'
Runner Image Provisioner
Operating System
Runner Image
GITHUB_TOKEN Permissions
Secret source: Actions
Prepare workflow directory
Prepare all required actions
Getting action download info
Download action repository 'appleboy/ssh-action@v1.0.3' (SHA:029f5b4aeeeb58fdfe1410a5d17f967dacf36262)
Complete job name: 🚀 Deploy to Staging
12s
Build container for action use: '/home/runner/work/_actions/appleboy/ssh-action/v1.0.3/Dockerfile'.
2s
Run appleboy/ssh-action@v1.0.3
/usr/bin/docker run --name d243c8f95f925acea4b58b5d7d6798558311b_0ce96e --label 6d243c --workdir /github/workspace --rm -e "INPUT_HOST" -e "INPUT_USERNAME" -e "INPUT_KEY" -e "INPUT_PORT" -e "INPUT_SCRIPT" -e "INPUT_PASSPHRASE" -e "INPUT_PASSWORD" -e "INPUT_SYNC" -e "INPUT_USE_INSECURE_CIPHER" -e "INPUT_CIPHER" -e "INPUT_TIMEOUT" -e "INPUT_COMMAND_TIMEOUT" -e "INPUT_KEY_PATH" -e "INPUT_FINGERPRINT" -e "INPUT_PROXY_HOST" -e "INPUT_PROXY_PORT" -e "INPUT_PROXY_USERNAME" -e "INPUT_PROXY_PASSWORD" -e "INPUT_PROXY_PASSPHRASE" -e "INPUT_PROXY_TIMEOUT" -e "INPUT_PROXY_KEY" -e "INPUT_PROXY_KEY_PATH" -e "INPUT_PROXY_FINGERPRINT" -e "INPUT_PROXY_CIPHER" -e "INPUT_PROXY_USE_INSECURE_CIPHER" -e "INPUT_SCRIPT_STOP" -e "INPUT_ENVS" -e "INPUT_ENVS_FORMAT" -e "INPUT_DEBUG" -e "INPUT_ALLENVS" -e "INPUT_REQUEST_PTY" -e "HOME" -e "GITHUB_JOB" -e "GITHUB_REF" -e "GITHUB_SHA" -e "GITHUB_REPOSITORY" -e "GITHUB_REPOSITORY_OWNER" -e "GITHUB_REPOSITORY_OWNER_ID" -e "GITHUB_RUN_ID" -e "GITHUB_RUN_NUMBER" -e "GITHUB_RETENTION_DAYS" -e "GITHUB_RUN_ATTEMPT" -e "GITHUB_ACTOR_ID" -e "GITHUB_ACTOR" -e "GITHUB_WORKFLOW" -e "GITHUB_HEAD_REF" -e "GITHUB_BASE_REF" -e "GITHUB_EVENT_NAME" -e "GITHUB_SERVER_URL" -e "GITHUB_API_URL" -e "GITHUB_GRAPHQL_URL" -e "GITHUB_REF_NAME" -e "GITHUB_REF_PROTECTED" -e "GITHUB_REF_TYPE" -e "GITHUB_WORKFLOW_REF" -e "GITHUB_WORKFLOW_SHA" -e "GITHUB_REPOSITORY_ID" -e "GITHUB_TRIGGERING_ACTOR" -e "GITHUB_WORKSPACE" -e "GITHUB_ACTION" -e "GITHUB_EVENT_PATH" -e "GITHUB_ACTION_REPOSITORY" -e "GITHUB_ACTION_REF" -e "GITHUB_PATH" -e "GITHUB_ENV" -e "GITHUB_STEP_SUMMARY" -e "GITHUB_STATE" -e "GITHUB_OUTPUT" -e "RUNNER_OS" -e "RUNNER_ARCH" -e "RUNNER_NAME" -e "RUNNER_ENVIRONMENT" -e "RUNNER_TOOL_CACHE" -e "RUNNER_TEMP" -e "RUNNER_WORKSPACE" -e "ACTIONS_RUNTIME_URL" -e "ACTIONS_RUNTIME_TOKEN" -e "ACTIONS_CACHE_URL" -e "ACTIONS_RESULTS_URL" -e GITHUB_ACTIONS=true -e CI=true -v "/var/run/docker.sock":"/var/run/docker.sock" -v "/home/runner/work/_temp/_github_home":"/github/home" -v "/home/runner/work/_temp/_github_workflow":"/github/workflow" -v "/home/runner/work/_temp/_runner_file_commands":"/github/file_commands" -v "/home/runner/work/copilotos-bridge/copilotos-bridge":"/github/workspace" 6d243c:8f95f925acea4b58b5d7d6798558311b
======CMD======
# Set environment
BRANCH="develop"
ENV_NAME=$([[ "$BRANCH" == "main" ]] && echo "production" || echo "staging")

echo "🚀 Deploying $BRANCH to $ENV_NAME..."

# Navigate to project
cd /home/jf/copilotos-bridge

# Quick git update
git fetch --depth=1 origin $BRANCH
git checkout $BRANCH
git reset --hard origin/$BRANCH

# Ultra-fast build (cached layers + fast dockerfile)
echo "🏗️ Building (cached)..."
docker-compose -f docker-compose.fast.yml build

# Stop old containers
docker-compose down || true

# Start with fast compose
echo "🔄 Starting services..."
docker-compose -f docker-compose.fast.yml up -d

# Quick health check (30s max)
echo "🔍 Health check..."
for i in {1..6}; do
  if curl -sf http://localhost:8001/api/health >/dev/null 2>&1; then
    echo "✅ API healthy"
    break
  fi
  [[ $i -eq 6 ]] && { echo "❌ API timeout"; exit 1; }
  sleep 5
done

for i in {1..6}; do
  if curl -sf http://localhost:3000 >/dev/null 2>&1; then
    echo "✅ Web healthy"
    break
  fi
  [[ $i -eq 6 ]] && { echo "❌ Web timeout"; exit 1; }
  sleep 5
done

# Show status
echo "🎉 $ENV_NAME deployment complete!"
echo "🌐 Web: http://34.42.214.246:3000"
echo "🔌 API: http://34.42.214.246:8001"

# Show running containers
docker-compose ps
======END======
out: 🚀 Deploying develop to staging...
err: fatal: not a git repository (or any of the parent directories): .git
err: fatal: not a git repository (or any of the parent directories): .git
err: fatal: not a git repository (or any of the parent directories): .git
out: 🏗️ Building (cached)...
err: bash: line 17: docker-compose: command not found
err: bash: line 20: docker-compose: command not found
out: 🔄 Starting services...
err: bash: line 24: docker-compose: command not found
out: 🔍 Health check...
out: ✅ API healthy
err: bash: line 52: docker-compose: command not found
out: ✅ Web healthy
out: 🎉 staging deployment complete!
out: 🌐 Web: http://34.42.214.246:3000
out: 🔌 API: http://34.42.214.246:8001
2025/09/18 04:01:42 Process exited with status 127
0s
Cleaning up orphan processes
